#!/usr/bin/env python3
"""
Подготовка регламента Воблаbeer для нарезки по чанкам RAG.
Добавляет иерархические метки разделов и подразделов, чтобы:
- каждый чанк однозначно относился к разделу;
- границы чанков совпадали с границами смысловых блоков (по смыслу, не по символам).
"""

import re
from pathlib import Path

# Оглавление регламента: номер и полное название раздела
SECTION_TITLES = [
    (1, "Введение. История компании"),
    (2, "Открытие ИП"),
    (3, "Поиск помещения для открытия магазина Воблаbeer"),
    (4, "Меркурий, ЕГАИС, Честный Знак"),
    (5, "Ремонтные работы помещения"),
    (6, "Требования по вывеске"),
    (7, "Мебель"),
    (8, "Оборудование"),
    (9, "Обучение партнера"),
    (10, "Подбор персонала"),
    (11, "Обучение персонала"),
    (12, "Инкассация"),
    (13, "Стандарты работы персонала магазина Воблаbeer"),
    (14, "Подлинность денежных купюр"),
    (15, "Необходимый пакет документов для трудоустройства сотрудников"),
    (16, "Работа с поставщиками"),
    (17, "Работа с подрядными организациями"),
    (18, "Маркетинг"),
    (19, "Инструкция по работе с отзывами"),
    (20, "Мерчандайзинг"),
    (21, "Уголок потребителя"),
    (22, "План проведения торжественного открытия точки"),
    (23, "Смета расходов на открытие и сопровождение"),
    (24, "Рекомендации по увеличению продаж магазина"),
    (25, "Чек-лист проверки магазина"),
    (26, "Общая информация"),
]

# Паттерны начала раздела в теле документа (первое вхождение после оглавления)
SECTION_START_PATTERNS = [
    (1, r"1\.\s+Введение\.\s+История компании"),  # в теле: "1. Введение. История компании."
    (2, r"^Открытие юридического лица"),  # раздел 2 начинается с этого подзаголовка (возможен ​ в конце)
    (3, r"^Поиск помещения для открытия магазина Воблаbeer"),
    (4, r"^4\.\s+Меркурий,?\s+ЕГАИС"),  # "4. Меркурий, ЕГАИС, Честный знак"
    (5, r"^5\.\s+Ремонтные работы помещения"),
    (6, r"^6\.\s+Требования по вывеске"),
    (7, r"^7\.\s+Мебель\.?\s*$"),
    (8, r"^8\.\s+Оборудование\.?\s*$"),
    (9, r"^9\.\s+Обучение партнера\.?\s*$"),
    (10, r"^10\.\s+Подбор персонала\.?\s*$"),
    (11, r"^11\.\s+Обучение персонала\.?\s*$"),
    (12, r"^12\.\s+Инкассация\.?\s*$"),
    (13, r"^13\.\s+Стандарты работы персонала"),
    (14, r"^14\.\s+Подлинность (купюр|денежных купюр)"),  # в теле может быть "14. Подлинность купюр"
    (15, r"^15\.\s+Необходимый пакет документов"),
    (16, r"^16\.\s+Работа с поставщиками"),
    (17, r"^17\.\s+Работа с подрядными"),
    (18, r"^18\.\s+Маркетинг\.?\s*$"),
    (19, r"^19\.\s+Инструкция по работе с\s*$"),  # "19. Инструкция по работе с\nотзывами"
    (20, r"^20\.\s+Мерчандайзинг\.?\s*$"),
    (21, r"^21\.\s+Уголок потребителя\.?\s*$"),
    (22, r"^22\.\s+План проведения (торжественного )?открытия точки"),  # в теле может быть без "торжественного"
    (23, r"^23\.\s+Смета расходов на открытие"),
    (24, r"^24\.\s+Рекомендации по увеличению"),  # в теле строка может обрываться
    (25, r"^25\.\s+Чек-лист проверки магазина"),
    (26, r"^26\.\s+Общая информация\.?\s*$"),
]

# Подзаголовки внутри разделов — превращаем в ### ПОДРАЗДЕЛ для смысловой нарезки
# (короткие фразы, по которым логично резать чанки)
SUBSECTION_HEADERS = [
    r"^История и философия бренда",
    r"^Формат и развитие",
    r"^Технологии как основа",
    r"^Ассортимент и предложение",
    r"^Ценности и цели",
    r"^Вместо вывода — приглашение",
    r"^Открытие юридического лица",
    r"^Эквайринг",
    r"^Чек-лист выбора месторасположения",
    r"^Особое внимание нужно обратить на Федеральный закон",
    r"^Список документов на проверку",
    r"^Пошаговые действия:",
    r"^Патентная система налогообложения",
    r"^Розничная продажа алкогольной продукции не допускаются",
    r"^Вы нашли помещение",
    r"^Совместно с согласованием договора аренды",
    r"^ФГИС \"Меркурий\"",
    r"^До пробития первого чека",
    r"^ЕГАИС \(Единая государственная",
    r"^Что такое ключ Рутокен",
    r"^\"Честный знак\"",
    r"^Как работает маркировка",
    r"^Инструкция по регистрации участника",
    r"^Ответы на самые распространенные вопросы",
    r"^Правила продажи пива",
    r"^Как принять пивные кеги",
    r"^Продажа разливного пива в ПЭТ-упаковке",
    r"^Учет потерь",
    r"^Оборудование и программы для учета",
    r"^Отчетность при продаже пива",
    r"^Ремонтные работы в помещении",
    r"^Осматриваем напольное покрытие",
    r"^Потолок:",
    r"^Самое важное, с чего начинается процесс ремонта",
    r"^Этапы устройства холодильной камеры",
    r"^Размер холодильной камеры",
    r"^Холодильные камеры утепляют",
    r"^Технологии\s*$",  # "Технологии" отдельная строка
    r"^Идет ГКЛ",
    r"^Монтаж пивного трубопровода",
    r"^Электрика:",
    r"^Далее идет процесс покраски стен",
    r"^Стены торговый зал",
    r"^Требования по вывескам",
    r"^Мебель\.\s*$",
    r"^Стена под краны",
    r"^Стол-ресепшен",
    r"^Для размещения снеков",
    r"^Оборудование\.\s*$",
    r"^Схема устройства пивной системы",
    r"^Устройство пивной системы",
    r"^Для чего используется газ",
    r"^Для размещение напитков в торговом зале",
    r"^Инструкция по правильной эксплуатации холодильного оборудования",
    r"^Выкладка продукции",
    r"^Уход, чистка холодильного оборудования",
    r"^Обучение партнера\.\s*$",
    r"^Подбор персонала\.\s*$",
    r"^Обучение персонала\.\s*$",
    r"^Инкассация\.\s*$",
    r"^Стандарты работы персонала",
    r"^Подлинность купюр",
    r"^Действия продавца в случае возникновения сомнений",
    r"^Признаки подлинности денежных купюр",
    r"^Необходимый пакет документов для трудоустройства",
    r"^Работа с поставщиками\.\s*$",
    r"^Работа с подрядными организациями",
    r"^Маркетинговые активности",
    r"^Бонусная карта Воблаbeer",
    r"^Инструкция по работе с отзывами",
    r"^Мерчандайзинг\s*$",
    r"^Принципы выкладки товара в пивной горке",
    r"^Инструкция по оформлению товара на паллетной выкладке",
    r"^Принципы выкладки рыбы",
    r"^Уголок потребителя",
    r"^План проведения открытия точки",
    r"^План проведения торжественного открытия точки",
    r"^Смета расходов",
    r"^Рекомендации по увеличению продаж магазина",
    r"^Чек-лист проверки магазина",
    r"^Общая информация\.\s*$",
    r"^Каплесборник",
    r"^Кабельные бирки",
    r"^Температурный режим",
    r"^Код доступа для работы на кассе",
    r"^Важные действия по работе с Честным знаком",
]


def find_section_starts(lines: list[str]) -> list[tuple[int, int, int]]:
    """Возвращает список (номер_раздела, индекс_строки, длина_заголовка) для каждого раздела."""
    results = []
    section_titles_dict = dict(SECTION_TITLES)
    # Пропускаем оглавление (строки 1–30, нумерация с 1); в теле раздел 1 с строки 32
    toc_end = 31
    for num, pattern in SECTION_START_PATTERNS:
        compiled = re.compile(pattern, re.MULTILINE | re.IGNORECASE)
        for i in range(toc_end, len(lines)):
            line = lines[i]
            if compiled.search(line.strip()):
                # Не дублируем: если уже нашли этот раздел, ищем следующий по порядку
                if not results or results[-1][0] != num:
                    results.append((num, i, len(line.strip())))
                break
    return results


def add_section_markers(lines: list[str], section_starts: list[tuple[int, int, int]]) -> list[str]:
    """Вставляет перед каждым разделом метку ## РАЗДЕЛ N. Название."""
    section_titles_dict = dict(SECTION_TITLES)
    out = []
    # Копируем оглавление как есть (до первого раздела в теле)
    first_body_section_line = section_starts[0][1] if section_starts else len(lines)
    for i in range(first_body_section_line):
        out.append(lines[i])

    for idx, (num, line_idx, _) in enumerate(section_starts):
        title = section_titles_dict.get(num, f"Раздел {num}")
        marker = f"\n## РАЗДЕЛ {num}. {title}\n"
        # Контент от line_idx до следующего section start (или до конца)
        next_start = section_starts[idx + 1][1] if idx + 1 < len(section_starts) else len(lines)
        # Первую строку раздела (заголовок в документе) оставляем, но перед всем блоком ставим метку
        out.append(marker)
        for j in range(line_idx, next_start):
            line = lines[j]
            # Опционально: подзаголовки внутри раздела помечаем как ### ПОДРАЗДЕЛ
            is_subsection = False
            for sub_pat in SUBSECTION_HEADERS:
                if re.match(sub_pat, line.strip(), re.IGNORECASE):
                    # Не помечаем, если это первая строка раздела (уже есть ## РАЗДЕЛ)
                    if j > line_idx:
                        out.append(f"\n### ПОДРАЗДЕЛ: {line.strip()}\n")
                        is_subsection = True
                    break
            if not is_subsection:
                out.append(line)
    return out


def main():
    base = Path(__file__).resolve().parent.parent
    input_path = Path("/Users/adelfarhutdinov/Downloads/knowledge.txt")
    output_path = base / "data" / "knowledge_rag_ready.md"

    if not input_path.exists():
        print(f"Файл не найден: {input_path}")
        return

    text = input_path.read_text(encoding="utf-8")
    lines = text.split("\n")

    section_starts = find_section_starts(lines)
    if len(section_starts) < 26:
        print(f"Найдено разделов: {len(section_starts)}, ожидалось 26. Найденные: {[s[0] for s in section_starts]}")

    # Сначала только метки разделов (## РАЗДЕЛ), без ### ПОДРАЗДЕЛ для простоты
    # Чтобы не дублировать логику, делаем один проход: вставляем только ## РАЗДЕЛ
    out_lines = []
    section_titles_dict = dict(SECTION_TITLES)
    first_body = section_starts[0][1] if section_starts else len(lines)

    # Правила нарезки для RAG (по плану: блок в начале файла, не ломает пайплайн бота)
    out_lines.append("### Правила нарезки")
    out_lines.append("")
    out_lines.append("- Чанк = логически связный фрагмент внутри одного раздела.")
    out_lines.append("- Не разрывать нумерованные шаги, чек-листы и списки посередине.")
    out_lines.append("- В метаданных чанка указывать: раздел (section), section_path и при возможности идентификатор чанка.")
    out_lines.append("- Разделы помечены «## РАЗДЕЛ N. Название», подразделы — «### ПОДРАЗДЕЛ: Название». Нарезку выполнять по смыслу по этим границам.")
    out_lines.append("")

    for i in range(first_body):
        out_lines.append(lines[i])

    for idx, (num, line_idx, _) in enumerate(section_starts):
        title = section_titles_dict.get(num, f"Раздел {num}")
        out_lines.append("")
        out_lines.append(f"## РАЗДЕЛ {num}. {title}")
        out_lines.append("")
        next_start = section_starts[idx + 1][1] if idx + 1 < len(section_starts) else len(lines)
        for j in range(line_idx, next_start):
            line = lines[j]
            # Проверяем, не является ли строка подзаголовком (короткая, без номера списка)
            stripped = line.strip()
            is_sub = (
                len(stripped) > 5
                and len(stripped) < 120
                and not re.match(r"^\d+[\.\)]\s+", stripped)
                and not re.match(r"^[-●•]\s", stripped)
                and any(re.match(p, stripped) for p in SUBSECTION_HEADERS)
            )
            if is_sub and j > line_idx:
                out_lines.append("")
                out_lines.append(f"### ПОДРАЗДЕЛ: {stripped}")
                out_lines.append("")
            else:
                out_lines.append(line)

    output_path.parent.mkdir(parents=True, exist_ok=True)
    output_path.write_text("\n".join(out_lines), encoding="utf-8")
    print(f"Готово. Подготовленный документ: {output_path}")
    print(f"Строк: {len(out_lines)}, размер ~{output_path.stat().st_size // 1024} КБ")


if __name__ == "__main__":
    main()
